<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>dk optimizer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<script defer>
  // function to get standings
  async function fetchStandings(league) {
    const response = await fetch(`/standings/${league}`);
    const data = await response.json();
    //create standings container
    const container = document.getElementById("standings-container");
    container.innerHTML = "";

    if (data.error) {
      container.innerHTML = `<p>${data.error}</p>`;
      return;
    }

    data.forEach((table) => {
      const groupEl = document.createElement("h4");
      groupEl.textContent = table.group || "Standings";
      container.appendChild(groupEl);

      const tableEl = document.createElement("table");

      const headerRow = document.createElement("tr");
      ["Rank", "Team", "Series"].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      tableEl.appendChild(headerRow);

      const order = ["rank", "team", "series"];
      table.standings.forEach(row => {
        const tr = document.createElement("tr");
        order.forEach(key => {
          const td = document.createElement("td");
          td.textContent = row[key] ?? "";
          tr.appendChild(td);
        });
        tableEl.appendChild(tr);
      });
      // table in container
      container.appendChild(tableEl);
    });
  }

  // creates vars
  let includedPlayers = [];
  let excludedPlayers = [];
  let allPlayers = []; 
  // function to load csv
  async function loadCSV() {
    //creates containers
    const container = document.getElementById("dk-salaries-container");
    const matchesContainer = document.getElementById("matches-container");
    const url = document.getElementById("csv-url-input").value;

    if (!url) {
      container.innerHTML = "<p>Please enter a URL</p>";
      return;
    }

    try {
      const response = await fetch(`/fetch_csv?url=${encodeURIComponent(url)}`);
      const csvText = await response.text();

      const rows = csvText.trim().split("\n").map(r => r.split(","));
      if (rows.length === 0) {
        container.innerHTML = "<p>No data found in CSV</p>";
        return;
      } 
      // enable optimize button when csv is loaded
      document.getElementById("optimize-btn").disabled = false;
      // trim csv to output table
      const desiredColumns = ["Roster Position", "Position", "Name", "Salary", "TeamAbbrev", "AvgPointsPerGame\r"];
      const headers = rows[0];
      const colIndexes = desiredColumns.map(col => headers.indexOf(col));

      const table = document.createElement("table");
      const headerTr = document.createElement("tr");
      desiredColumns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        headerTr.appendChild(th);
      });
      const actionTh = document.createElement("th");
      actionTh.textContent = "Actions";
      headerTr.appendChild(actionTh);
      table.appendChild(headerTr);

      allPlayers = []; 

      rows.slice(1).forEach(row => {
        const tr = document.createElement("tr");
        let playerObj = {};

        colIndexes.forEach((idx, i) => {
          const td = document.createElement("td");
          const raw = idx >= 0 ? row[idx] : "";
          const val = raw.replace?.("\r","") ?? raw;
          td.textContent = val;
          tr.appendChild(td);
          playerObj[desiredColumns[i]] = val;
        });
 
        playerObj.Salary = parseInt(playerObj.Salary, 10);
        playerObj["AvgPointsPerGame"] = parseFloat(playerObj["AvgPointsPerGame\r"]);

        allPlayers.push(playerObj);

        // creates action buttons
        const actionTd = document.createElement("td");
        const name = playerObj.Name;

        const includeBtn = document.createElement("button");
        includeBtn.textContent = "+";
        includeBtn.classList.add("include-btn");

        const excludeBtn = document.createElement("button");
        excludeBtn.textContent = "x";
        excludeBtn.classList.add("exclude-btn");
        // action button events
        includeBtn.onclick = () => {
          if (includedPlayers.includes(name)) {
            includedPlayers = includedPlayers.filter(p => p !== name);
            includeBtn.classList.remove("included");
          } else {
            includedPlayers.push(name);
            // remove from excluded if present
            excludedPlayers = excludedPlayers.filter(p => p !== name);
            excludeBtn.classList.remove("excluded");
            includeBtn.classList.add("included");
          }
        };

        excludeBtn.onclick = () => {
            if (excludedPlayers.includes(name)) {
                // un-exclude
                excludedPlayers = excludedPlayers.filter(p => p !== name);
                excludeBtn.classList.remove("excluded");
            } else {
                // exclude
                excludedPlayers.push(name);
                includeBtn.classList.remove("included");
                includedPlayers = includedPlayers.filter(p => p !== name);
                excludeBtn.classList.add("excluded");
            }
            console.log("Excluded players:", excludedPlayers); // ✅ debug check
        };


        actionTd.appendChild(includeBtn);
        actionTd.appendChild(excludeBtn);
        tr.appendChild(actionTd);

        table.appendChild(tr);
      });

      container.innerHTML = "";
      container.appendChild(table);
      // shows matches at the top doesnt work here
      matchesContainer.innerHTML = "";

    } catch (err) {
      container.innerHTML = `<p>Error loading CSV: ${err.message}</p>`;
    }
  }

  // calls backend optimzer funciton and generates lineups
  async function optimizeLineups() {
    const bottom = document.querySelector(".bottom");
    bottom.innerHTML = "<p>Generating lineups…</p>";

    try {
      const res = await fetch("/optimize", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          players: allPlayers,
          included: includedPlayers,
          excluded: excludedPlayers
        })
      });
      const data = await res.json();
      
      //console.log(excludedPlayers)
      //console.log(allPlayers)
      bottom.innerHTML = "";

      if (!data.lineups || data.lineups.length === 0) {
        bottom.innerHTML = "<p>No valid lineups found with current constraints.</p>";
        return;
      }
      // creates lineup tables
      data.lineups.forEach((lineup, idx) => {
        const title = document.createElement("h3");
        title.textContent = `Lineup ${idx + 1}`;
        bottom.appendChild(title);

        const table = document.createElement("table");
        const header = document.createElement("tr");
        ["Pos", "Player", "Team", "AvgPts", "Salary"].forEach(h => {
          const th = document.createElement("th");
          th.textContent = h;
          header.appendChild(th);
        });
        table.appendChild(header);

        let totalSalary = 0;
        let totalPoints = 0;

        lineup.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.Pos}</td>
            <td>${row.Player}</td>
            <td>${row.Team}</td>
            <td>${Number(row.AvgPts).toFixed(2)}</td>
            <td>${row.Salary}</td>
          `;
          table.appendChild(tr);
          totalSalary += Number(row.Salary);
          totalPoints += Number(row.AvgPts);
        });

        const totals = document.createElement("tr");
        totals.classList.add("totals-row");
        totals.innerHTML = `
          <td colspan="3">Totals</td>
          <td>${totalPoints.toFixed(2)}</td>
          <td>${totalSalary}</td>
        `;
        table.appendChild(totals);

        bottom.appendChild(table);
      });
    } catch (err) {
      bottom.innerHTML = `<p>Error optimizing: ${err.message}</p>`;
    }
  }

  // hook optimize button
  window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("optimize-btn").disabled = true;
    document.getElementById("optimize-btn").onclick = optimizeLineups;
  });
</script>
</head>
<body>
  <div class="container">
    <div class="column1">
      <h2>Leagues</h2>
      <button onclick="fetchStandings('lpl')">LPL</button>
      <button onclick="fetchStandings('lck')">LCK</button>
      <button onclick="fetchStandings('lta')">LTA</button>
      <button onclick="fetchStandings('lec')">LEC</button>
      <h3>Standings</h3>
      <div id="standings-container"></div>
    </div>

    <div class="column2">
      <h2>Contests</h2>
      <input type="text" id="csv-url-input" placeholder="Enter CSV URL" style="width:100%;margin-bottom:10px;">
      <button onclick="loadCSV()">Load CSV</button>
      <div id="matches-container" style="margin:20px 0; display:flex; gap:10px; flex-wrap:wrap;"></div>
      <div id="dk-salaries-container" class="scrollable-table-container"></div>
      <button id="optimize-btn">Optimize</button>
    </div>
  </div>

  <div class="bottom"></div>
</body>
</html>
